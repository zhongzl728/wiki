# مذكرات تطوير مكتبة HAL - التواصل عبر المنفذ التسلسلي

تعتمد هذه المقالة على مجموعة تطوير RobotCtrl الخاصة بنا، حيث يتم استخدام النواة المدمجة في المتحكم STM32F407ZET6 وشريحة SP3232EEN للاتصال RS-232. يمكنك العثور على المخطط الأساسي والمعلومات التفصيلية في [**RobotCtrl - مجموعة تطوير STM32 العامة**](https://wiki-power.com/RobotCtrl-STM32%E9%80%9A%E7%94%A8%E5%BC%80%E5%8F%91%E5%A5%97%E4%BB%B6).

## المبادئ الأساسية

لفهم المبادئ الأساسية للتواصل عبر المنفذ التسلسلي، يُفضل قراءة المقالة [**بروتوكولات الاتصال - التواصل عبر المنفذ التسلسلي**](https://wiki-power.com/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE-%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1).

## تجربة التواصل عبر المنفذ التسلسلي

قبل البدء في التجارب القادمة، يتعين عليك تكوين معلومات مثل التنزيل عبر المنفذ وتكوين الساعة وغيرها في CubeMX. لمزيد من التفاصيل حول الخطوات المحددة، يُفضل مراجعة المقالة [**مذكرات تطوير مكتبة HAL - تكوين البيئة**](https://wiki-power.com/HAL%E5%BA%93%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE).

### تكوين المنفذ داخل CubeMX

![CubeMX](https://media.wiki-power.com/img/20210207100329.png)

وفقًا للمخطط الأساسي، المنفذ الذي سنستخدمه في تجربة التواصل هو `USART1` ويُمثلهم `PA9` و`PA10`. لذا، يتعين عليك أولاً تكوين هذين السنتين كوظيفة إرسال واستقبال لمنفذ `USART1` داخل CubeMX. بعد ذلك، انتقل إلى علامة `USART1` في الجانب الأيسر وحدد الوضع (Mode) كونه غير متزامن (Asynchronous) وقم بتعديل معلمات مثل معدل الباود (Baud Rate) وغيرها على الجانب السفلي كما يلي:

![CubeMX](https://media.wiki-power.com/img/20210207100941.png)

التفاصيل عن المعلمات:

- **إعدادات معدل الباود** (Baud Rate): ليس هناك معدل باود واحد يعمل بشكل جيد في جميع الحالات، لذا يجب تعديله وفقًا للحالة الفعلية لضمان التوافق مع مساعد تصحيح التواصل عبر المنفذ.
- **عدد البتات في الكلمة** (Word Length): إذا تم تمكين التحقق من الزوجية/الفردية، سيتم خصم بت واحد عن البيانات الفعلية.
- **التحقق من الزوجية/الفردية** (Parity): يمكن اختيار التحقق من الزوجية أو الفردية أو عدم التحقق.
- **عدد بتات التوقف** (Stop Bits): تُستخدم بتين إضافيين كإشارة للإنتهاء من الإرسال أو الاستقبال.
- **اتجاه البيانات** (Data Direction): يمكن اختيار وضع الإرسال فقط أو الاستقبال فقط أو وضع الإرسال والاستقبال معًا.
- **معدل العينة الزائدة** (Over Sampling): يُستخدم معدل العينة الزائدة 8 مرات أو 16 مرة لتجنب الأخطاء في البيانات.

أخيرًا، تمكين انقطاع المنفذ السلسلي USART1 داخل علامة NVIC، كما هو موضح في الصورة:

![CubeMX](https://media.wiki-power.com/img/20210207104641.png)

### تكوين المنفذ في الشيفرة

أولاً، يجب إضافة الشيفرة التالية إلى نهاية الملف `stm32f4xx_it.c`:

````c title="stm32f4xx_it.c

```c title="main.c"
/* المتغيرات الخاصة -----------------------------------------------------------*/
/* USER CODE BEGIN PV */

uint8_t aTxBuffer[] = "اختبار USART\r\n"; // سلسلة تُرسل
uint8_t aRxBuffer[20]; // سلسلة تُستقبل

/* USER CODE END PV */
````

```c title="stm32f4xx_it.c"
/* المتغيرات الخاصة -----------------------------------------------------------*/
/* USER CODE BEGIN PV */

extern uint8_t aTxBuffer;
extern uint8_t aRxBuffer;

/* USER CODE END PV */
```

وبالإضافة إلى ذلك، في ملف `main.c`، نحتاج إلى إضافة دالة تمكين انقطاع الاستقبال بعد تهيئة المنفذ التسلسلي قبل دورة البرنامج الرئيسية:

```c title="main.c"
/* USER CODE BEGIN 2 */

HAL_UART_Receive_IT(&huart1, (uint8_t *)aRxBuffer, 1); // دالة تمكين انقطاع الاستقبال

/* USER CODE END 2 */
```

يمكنك أيضًا إرسال رسالة تهيئة للإشارة إلى أن المنفذ التسلسلي قد تم تشغيله:

```c title="main.c"
/* USER CODE BEGIN 2 */

HAL_UART_Transmit(&huart1, (uint8_t*) aTxBuffer, sizeof(aTxBuffer) - 1, 0xFFFF); // إرسال محتوى aTxBuffer المُخصص سابقًا

/* USER CODE END 2 */
```

إذا كنت بحاجة إلى إعادة توجيه دالة printf (استخدام دالة printf في STM32 لإخراج البيانات عبر المنفذ التسلسلي)، يُرجى الرجوع إلى [**إعادة توجيه STM32CubeIDE للمنفذ التسلسلي (printf) وإخراج الأعدادات العائمة**](https://wiki-power.com/STM32CubeIDE%E4%B8%B2%E5%8F%A3%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%88printf%EF%BC%89%E5%8F%8A%E8%BE%93%E5%87%BA%E6%B5%AE%E7%82%B9%E5%9E%8B) للمزيد من المعلومات.

### التنزيل والتحقق

بعد نجاح تنفيذ البرنامج، افتح أداة المساعدة للمنفذ التسلسلي وقم بتكوين المنفذ وسرعة الباود.

عند الاتصال بالمنفذ التسلسلي، ستقوم أولاً بطباعة محتوى `aTxBuffer`، ثم ستقوم بإعادة طباعة المحتوى الذي تم استقباله في `aRxBuffer`. يمكنك الرؤية في الصورة أدناه:

![](https://media.wiki-power.com/img/20210403232628.png)

## المراجع والشكر

- [STM32CubeMX Practical Tutorial (Six) - Serial Communication](https://blog.csdn.net/weixin_43892323/article/details/105339949)
- [Advanced III [UART & USART]](https://alchemicronin.github.io/posts/b4c69a89/#1-0-%E4%BB%80%E4%B9%88%E6%98%AFUART%E5%92%8CUSART%EF%BC%9F%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%E5%98%9B%EF%BC%9F)
- [Non-blocking HAL_UART_Receive_IT in STM32 - Explanation and Practical Application](https://zhuanlan.zhihu.com/p/147414331)
- [HAL Library Tutorial 6: Serial Data Reception](https://blog.csdn.net/geek_monkey/article/details/89165040)

> عنوان النص: <https://wiki-power.com/>
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.
