# ูุฐูุฑุงุช ุชุทููุฑ ููุชุจุฉ HAL - ุงูุงุชุตุงู ุจุดุจูุฉ ุงูุฅูุซุฑูุช (LwIP) ๐ง

ูููุง ููู ุฏููู ุงุณุชูุงุฏู ุฅูู [**ููุญุฉ ุชุญูู ุงูููุงุฉ ุงูุฑุฆูุณูุฉ STM32F407 ุงููุนููุณุฉ**](https://item.taobao.com/item.htm?spm=a230r.1.14.16.57314534365ZlN&id=569068950037&ns=1&abbucket=4#detail) ู[**ูุญุฏุฉ ุงูููุฒูุงุก DP83848 ูุดุจูุฉ ุงูุฅูุซุฑูุช**](https://item.taobao.com/item.htm?spm=a230r.1.14.1.38df5bd3YTS6rE&id=12873819988&ns=1&abbucket=4#detail).

## ุงูููููุงุช ุงููุงุฑุฏููุฑูุฉ

ูุงุฌูุฉ DP83848 ุชุณุชุฎุฏู ุชูููุฉ RMIIุ ูุชุฏุนู DP83848 ุณุฑุนุงุช ุฎุทูุฉ ุชุตู ุฅูู 10 ููุฌุงุจุช/ุซุงููุฉ ู 100 ููุฌุงุจุช/ุซุงููุฉุ ูููุงู ุนุฑุถ ุชุฑุฏุฏ ุจุฏูู ููุฉ ูุจูุบ 50 ููุฌุงูุฑุชุฒ ุนูู ุงูููุญุฉ.

| ุงูููุงุฉ ุงูุฑุฆูุณูุฉ STM32 | ูุญุฏุฉ DP83848 |
| --------------------- | ------------ |
| ETH_REF_CLK           | PA1          |
| ETH_MDIO              | PA2          |
| ETH_MDC               | PC1          |
| ETH_CRS_DV            | PA7          |
| ETH_RXD0              | PC4          |
| ETH_RXD1              | PC5          |
| ETH_TX_EN             | PB11         |
| ETH_TXD0              | PB12         |
| ETH_TXD1              | PB13         |

## ุงูุจุฑูุฌูุงุช

### ุชูููู ุฏุงุฎูู ุจุงุณุชุฎุฏุงู CubeMX

- RCC: ุงุฎุชูุงุฑ ุงููุฑุณุชุงู ุงูุฎุงุฑุฌู HSE
- SYS
  - DEBUG: SW
- GPIO
  - PA15: `USER_BTN`ุ ุฅุฏุฎุงูุ ูุน ููุงููุฉ ุณุญุจ ุนุงููุฉ
  - PC13: `LED_GREEN`ุ ุฅุฎุฑุงุฌ ูุดุท ุฅูุฌุงุจูุ ูุณุชูู ุนุงูู
  - PC14: `LED_BLUE`ุ ุฅุฎุฑุงุฌ ูุดุท ุฅูุฌุงุจูุ ูุณุชูู ุนุงูู
  - PC15: `LED_RED`ุ ุฅุฎุฑุงุฌ ูุดุท ุฅูุฌุงุจูุ ูุณุชูู ุนุงูู
- ETH
  - Mode: RMII
  - Advanced Parameters
    - PHY: ุนููุงู DP83848_PHY_ADDRESS
- LWIP
  - ุฎูุงุฑุงุช ุฑุฆูุณูุฉ
    - ุชุญุฏูุฏ ุฎูุงุฑ "Show Advanced Parameters"
    - ุชุฃูุฏ ูู ุฃู LWIP_NETIF_LINK_CALLBACK ููุนู (ุนุงุฏุฉ ููุนู ุงูุชุฑุงุถููุง)
    - xLWIP_LOOPIF_MULTICAST: ุชูููู
    - xLWIP_MULTICAST_TX_OPTIONS: ุชูููู
    - xLWIP_NETIF_STATUS_CALLBACK: ุชูููู
    - xLWIP_NETIF_EXT_STATUS_CALLBACK: ุชูููู
    - xLWIP_SO_RCVBUF: ุชูููู
  - ุฅุนุฏุงุฏุงุช ุนุงูุฉ
    - xLWIP_IGMP: ุชูููู

ุชูููู ุดุฌุฑุฉ ุงูุณุงุนุฉ: ุงุณุชูุงุฏูุง ุฅูู ุชุฑุฏุฏ ุงููุฑุณุชุงู ุนูู ุงูููุญุฉ (8 ููุฌุงูุฑุชุฒ ูู ูุฐุง ุงูููุญุฉ).

![](https://media.wiki-power.com/img/20220702145310.png)

### ุฅุถุงูุฉ ุฑูุฒ ุงููุธููุฉ

```c title="main.c"
/* USER CODE BEGIN PV */
extern struct netif gnetif;
/* USER CODE END PV */
```

```c
void ethernetif_notify_conn_changed(struct netif *netif) {
	/* ููุญูุธุฉ: ูููู ุชูููุฐ ูุฐู ุงููุธููุฉ ูู ููู ุงููุณุชุฎุฏู ุนูุฏ ุงูุญุงุฌุฉ
	 ุฅูู ุงูุงุณุชุฏุนุงุก. */
	if (netif_is_link_up(netif)) {
		HAL_GPIO_WritePin(LED_GREEN_GPIO_Port, LED_GREEN_Pin, GPIO_PIN_RESET);
		HAL_GPIO_WritePin(LED_RED_GPIO_Port, LED_RED_Pin, GPIO_PIN_SET);
	} else {
		HAL_GPIO_WritePin(LED_GREEN_GPIO_Port, LED_GREEN_Pin, GPIO_PIN_SET);
		HAL_GPIO_WritePin(LED_RED_GPIO_Port, LED_RED_Pin, GPIO_PIN_RESET);
	}
}

ethernetif_notify_conn_changed(&gnetif);

MX_LWIP_Process();
```

```c title="lwip.c"
ethernetif_set_link(&gnetif);
if (netif_is_link_up(&gnetif) && !netif_is_up(&gnetif)) {
	netif_set_up(&gnetif);
	dhcp_start(&gnetif);
}
```

## ุชุตุญูุญ

- ุงุณุชุนุฑุถ ุนูุงููู IP ุงููุชุตูุฉ ุจูุฐุง ุงูููุจููุชุฑ: `arp -a`
- ุชุญุฏูุฏ ุนููุงู IP ููุญุฏุฉ STM32 ุนุจุฑ ุฅุฏุฑุงุฌ ููุตู ุงููุจู.
- `ping [ุนููุงู IP] (-t)`
- ุฅุฐุง ุชู ุฅุฒุงูุฉ ุงููุจู ูุฅุนุงุฏุฉ ุชูุตููู ุจุณุฑุนุฉุ ูุฏ ูุญุฏุซ "ูุดู ูู ุงููููุ ุฎุทุฃ ุดุงุฆุน"ุ ุงูุชุธุฑ ูุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู ุชููุงุฆูุงู.

## ุงููุฑุงุฌุน ูุงูุดูุฑ

- [ุชููุฆุฉ Ethernet ุจุงุณุชุฎุฏุงู STM32 HAL](https://blog.naver.com/eziya76/221852430347)

> ุนููุงู ุงููุต: <https://wiki-power.com/>
> ูุชู ุญูุงูุฉ ูุฐุง ุงูููุงู ุจููุฌุจ ุงุชูุงููุฉ [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)ุ ููุฑุฌู ุฐูุฑ ุงููุตุฏุฑ ุนูุฏ ุฅุนุงุฏุฉ ุงููุดุฑ.

---

```
ูุนุชูุฏ ูุฐุง ุงูููุงู ุนูู ูุฌููุนุฉ ุชุทููุฑ RobotCtrl ุงููุฎุตุตุฉ ุฐุงุชูุฉ ุงูุฅูุชุงุฌุ ูุงูุชู ุชุณุชุฎุฏู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ STM32F407ZET6 ูููุงุฉ ูุฑูุงูุฉ PHY Ethernet ูู LAN8720A. ููุญุตูู ุนูู ุงููุฎุทุท ุงูุฃุณุงุณู ููุฒูุฏ ูู ุงูุชูุงุตููุ ูุฑุฌู ุฒูุงุฑุฉ [**RobotCtrl - STM32 ้็จๅผๅๅฅไปถ**](https://wiki-power.com/RobotCtrl-STM32%E9%80%9A%E7%94%A8%E5%BC%80%E5%8F%91%E5%A5%97%E4%BB%B6) (ุจุงููุบุฉ ุงูุตูููุฉ).

ุจุฑูุชูููู LwIP ูู ุจุฑูุชูููู IP ุฎููู ุงููุฒู ูููู ุชุดุบููู ุจุบุถ ุงููุธุฑ ุนู ูุฌูุฏ ุฏุนู ููุธุงู ุงูุชุดุบูู. ูุชูุญูุฑ ุชูููุฐ LwIP ุญูู ุงูุญูุงุธ ุนูู ูุธุงุฆู ุจุฑูุชูููู TCP ุงูุฑุฆูุณูุฉ ูุน ุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุงูุนุดูุงุฆูุฉ. ูุญุชุงุฌ LwIP ุฅูู ุญูุงูู ุนุดุฑุงุช ุงูููููุจุงูุชุงุช ูู ุงูุฐุงูุฑุฉ ุงูุนุดูุงุฆูุฉ ูุญูุงูู 40 ููููุจุงูุช ูู ุงูุฐุงูุฑุฉ ุงููุฑุงุกุฉ ููุท ููุนููุ ููุง ูุฌุนูู ููุงุณุจูุง ููุงุณุชุฎุฏุงู ูู ุฃูุธูุฉ ุงููุฏูุฌุฉ ุนูู ุงูุทุฑู ุงูุณููู.

ููุฏู LwIP ุซูุงุซ ูุงุฌูุงุช ุจุฑูุฌุฉ ูุฎุชููุฉ ูู RAW/Callback API ูNETCONN API ูSOCKET API. ูุฒุฏุงุฏ ุณูููุฉ ุงูุงุณุชุฎุฏุงู ูู ุงููุณุงุฑ ุฅูู ุงูููููุ ูู ุญูู ูุชูุงูุต ููุงุกุฉ ุงูุชูููุฐ ุจุงูุงุชุฌุงู ููุณู. ููููู ุชุญููู ุงูุชูุงุฒู ุจูู ุงููุฒุงูุง ูุงูุนููุจ ูุงุฎุชูุงุฑ ูุงุฌูุฉ ุจุฑูุฌุฉ ุชูุงุณุจ ุงุญุชูุงุฌุงุชู. ูู ูุฐุง ุงูููุงูุ ุชู ุงุณุชุฎุฏุงู ูุงุฌูุฉ Raw API ูุงุณุชุฏุนุงุก ุงูุฏูุงู ุงูุชุงููุฉ:
```

| API Function   | Description                                               |
| -------------- | --------------------------------------------------------- |
| udp_new        | ุฅูุดุงุก PCB UDP ุฌุฏูุฏ                                        |
| udp_remove     | ุฅุฒุงูุฉ PCB UDP ูุชุญุฑูุฑ ุงูููุงุฑุฏ ุฐุงุช ุงูุตูุฉ                    |
| udp_bind       | ุฑุจุท PCB UDP ุจุนููุงู IP ุงููุญูู ูุงููููุฐ                      |
| udp_connect    | ุฅูุดุงุก PCB UDP ุจุนููุงู IP ููููุฐ ุจุนูุฏูู                      |
| udp_disconnect | ุฅุฒุงูุฉ ุนููุงู IP ููููุฐ ุจุนูุฏูู ูู PCB UDP                    |
| udp_send       | ุฅุฑุณุงู ุจูุงูุงุช UDP                                          |
| udp_recv       | ุชุณุฌูู ูุธููุฉ ุงูุชุธุงุฑ ุงุณุชูุจุงู ุงูุจูุงูุงุช ุนูุฏ ุงุณุชูุงู ุญุฒูุฉ ุฌุฏูุฏุฉ |

## ุชูููู ุฏุงุฎู CubeMX

1. ูู ุตูุญุฉ `RCC`ุ ูู ุจุงุฎุชูุงุฑ ุงููุฐุจุฐุจ ุงูุฎุงุฑุฌู ูู HSE.
2. ูู ุตูุญุฉ `ETH`ุ ูู ุจุชูููู ูุถุน PHY ูู `RMII`ุ ููู ุจุชูููู ุงูุจุงุฑุงูุชุฑุงุช ุงูุชุงููุฉ:
   1. ูู ุนูุงูุฉ ุชุจููุจ `Parameter Setting`ุ ูู ุจุชูููู `PHY Address` ูู `0` (ุจูุงุกู ุนูู ุชูููู ุฏุจูุณ PHYAD0).
   2. ูู ุนูุงูุฉ ุชุจููุจ `Advanced Parameter`ุ ุงุณุชูุงุฏูุง ุฅูู ุฏููู ุฑูุงูุฉ LAN8720Aุ ูู ุจุชูููู `PHY special control/status register Offset` ูู `31`ุ ููู ุจุชูููู `PHY Speed mask` ูู `0x0004`ุ ููู ุจุชูููู `PHY Duplex mask` ูู `0x0010`.
3. ูู ุตูุญุฉ `LWIP`ุ ูู ุจุชูููููุง ููู ุจุชูููู ุงูุจุงุฑุงูุชุฑุงุช ุงูุชุงููุฉ:
   1. ูู ุนูุงูุฉ ุชุจููุจ `General Settings`ุ ูู ุจุชูููู `LWIP_DHCP (ูุญุฏุฉ DHCP)` ูู `Disabled` (ุงุณุชุฎุฏุงู ุนููุงู IP ุซุงุจุช)ุ ููู ุจุชูููู `IP_ADDRESS` ูู `192.168.001.100`ุ ููู ุจุชูููู `NETMASK_ADDRESS` ูู `255.255.255.000`ุ ููู ุจุชูููู `GATEWAY_ADDRESS` ูู `192.168.001.001`ุ ููู ุจุชูููู `LWIP_UDP (ูุญุฏุฉ UDP)` ู `LWIP_TCP (ูุญุฏุฉ TCP)`.

## ูุฑุงุฌุน ูุดูุฑ

- [LwIP TCP/IP stack demonstration for STM32F4x7 microcontrollers (AN3966)](https://www.st.com/en/embedded-software/stsw-stm32070.html)
- [Developing applications on STM32Cube with LwIP TCP/IP stack (UM1713)](https://www.st.com/resource/en/user_manual/um1713-developing-applications-on-stm32cube-with-lwip-tcpip-stack-stmicroelectronics.pdf)
- [54zorb/stm32-lwip](https://github.com/54zorb/stm32-lwip)

> ุนููุงู ุงููุต: <https://wiki-power.com/>
> ูุชู ุญูุงูุฉ ูุฐุง ุงูููุงู ุจููุฌุจ ุงุชูุงููุฉ [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)ุ ููุฑุฌู ุฐูุฑ ุงููุตุฏุฑ ุนูุฏ ุฅุนุงุฏุฉ ุงููุดุฑ.

> ุชูุช ุชุฑุฌูุฉ ูุฐู ุงููุดุงุฑูุฉ ุจุงุณุชุฎุฏุงู ChatGPTุ ูุฑุฌู [**ุชุฒููุฏูุง ุจุชุนูููุงุชูู**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) ุฅุฐุง ูุงูุช ููุงู ุฃู ุญุฐู ุฃู ุฅููุงู.
