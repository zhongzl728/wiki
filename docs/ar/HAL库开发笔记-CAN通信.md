# ูุฐูุฑุงุช ุชุทููุฑ ููุชุจุฉ HAL - ุงุชุตุงู CAN ๐ง

ุชุณุชูุฏ ูุฐู ุงูููุงูุฉ ุฅูู ูุฌููุนุฉ ุฃุฏูุงุช ุชุทููุฑ RobotCtrl ุงููุตููุฉ ุฐุงุชููุงุ ูุน ููุงุฉ ูููุฑูููุชุฑููุฑ STM32F407ZET6ุ ูุงุณุชุฎุฏุงู ุงุชุตุงู CAN ุจุงุณุชุฎุฏุงู ุดุฑูุญุฉ TJA1050. ููุฑุฌู ุงูุฑุฌูุน ุฅูู [**RobotCtrl - STM32 ้็จๅผๅๅฅไปถ**](https://wiki-power.com/RobotCtrl-STM32%E9%80%9A%E7%94%A8%E5%BC%80%E5%8F%91%E5%A5%97%E4%BB%B6) ูููุฒูุฏ ูู ุงูุชูุงุตูู ูุงูุฑุณููุงุช ุงูุชูุถูุญูุฉ.

## ุฎุทูุงุช ุจุณูุทุฉ ูุงุฎุชุจุงุฑ ุงูุญููุฉ ุงููุบููุฉ

### ุชูููู ุฏุงุฎู CubeMX

1. ุงุณุชูุงุฏูุง ุฅูู ุนุชุงุฏ CAN ุงููุณุชุฎุฏูุ ุงูุชูู ุฅูู ุตูุญุฉ `CAN1` ุฃู `CAN2` ูู ุงูุดุฑูุท ุงูุฌุงูุจู ุงูุฃูุณุฑุ ูุญุฏุฏ `ุชูุดูุท` (Activated). ุซู ูู ุจุชูููู ูุฐู ุงููุนููุงุช ูู ุตูุญุฉ ุงููุนููุงุช:
   1. ูู ุจุชุนููู `Prescaler (for Time Quantum)` ุฅูู `6`ุ ูุญุฏุฏ `Time Quanta in Bit Segment 1` ู `Time Quanta in Bit Segment 2` ุนูู `3 Times`. ูุฐุง ุงูุฌูุน ุณูุนูู ูุนุฏู ุงูุจุช ุจููุฏุงุฑ 1 ููุฌุงุจุช ูู ุงูุซุงููุฉ (ุงูุฃุนูู).
   2. ุถุจุท `ReSynchronization Jump Width` ุนูู `1 Time`ุ ููุฐุง ูู ุฃูุตู ูุฏุฑ ูููู ุชุนุฏููู ุฃุซูุงุก ุฅุนุงุฏุฉ ุงููุฒุงููุฉ.
   3. ุชุนููู `Operating Mode` ุฅูู `Loopback`ุ ููุฐุง ููุงุฎุชุจุงุฑ ุฏุงุฎู ุงูุญููุฉ ุงููุบููุฉ.

2. ูู ุนูุงูุฉ ุงูุชุจููุจ `NVIC Settings`ุ ูู ุจุชูููู `CANx RX0 interrupts`.


### ุชูููู ุฏุงุฎู ุงูููุฏ

ูู ุจุฅูุดุงุก ููู `can.c` ูู ูุดุฑูุนู ููู ุจุชูููู ุงููุฑุดุญุงุช. ูู ูุฐุง ุงููุซุงูุ ุชู ุชูููู ูุถุน ุงููุงุฆูุฉ ูุชู ุชุตููุฉ ูุนุฑู ููุชุฏ `0x2233` ููุนุฑู ููุงุณู `0`:

```c title="can.c"/*
 * ุงุณู ุงููุธููุฉ: CAN_Filter_Config
 * ุงููุตู: ุชูููู ูุฑุดุญ CAN
 * ุงููุฏุฎูุงุช: ูุง ุดูุก
 * ุงููุฎุฑุฌุงุช: ูุง ุดูุก
 * ุงุณุชุฏุนุงุก: ุงุณุชุฏุนุงุก ุฏุงุฎูู
 */
static void CAN_Filter_Config(void) {
    CAN_FilterTypeDef CAN_FilterTypeDef;

    /* ุชูููู ูุฑุดุญ CAN */
    CAN_FilterTypeDef.FilterBank = 0;                        // ูุฌููุนุฉ ุงููุฑุดุญ 0
    CAN_FilterTypeDef.FilterMode = CAN_FILTERMODE_IDLIST;     // ุชุนูู ูู ูุถุน ุงููุงุฆูุฉ
    CAN_FilterTypeDef.FilterScale = CAN_FILTERSCALE_32BIT;    // ุนุฑุถ ุงููุฑุดุญ 32 ุจุช ูุฑุฏู.
    /* ุชูููู ุงููุฑุดุญุ ุญูุซ ูุชู ููุงุฑูุฉ ูุญุชูู ุงูุนูุงูุงุช ุงูุชุฌุงุฑูุฉุ ููุชู ุชุฌุงูู ูุง ูู ุชูู ุงููููุฉ ุงูููุชุฏุฉ ูู ููุง ูููุ ุณุชุชู ุฅุถุงูุชูุง ุฅูู FIFO0. */

    CAN_FilterTypeDef.FilterIdHigh = ((((uint32_t) 0x2233 << 3) | CAN_ID_EXT
            | CAN_RTR_DATA) & 0xFFFF0000) >> 16;        // ุฃุนูู ุจุช ูู ุงููููุฉ ุงููุฑุงุฏ ุชุตููุฉูุง
    CAN_FilterTypeDef.FilterIdLow = (((uint32_t) 0x2233 << 3) | CAN_ID_EXT
            | CAN_RTR_DATA) & 0xFFFF;                   // ุฃุฏูู ุจุช ูู ุงููููุฉ ุงููุฑุงุฏ ุชุตููุฉูุง
    CAN_FilterTypeDef.FilterMaskIdHigh = 0;        // ุฃุนูู ุจุช ูููููุฉ ุงูุซุงููุฉ
    CAN_FilterTypeDef.FilterMaskIdLow = 0;         // ุฃุฏูู ุจุช ูููููุฉ ุงูุซุงููุฉ
    CAN_FilterTypeDef.FilterFIFOAssignment = CAN_FILTER_FIFO0;    // ุงููุฑุดุญ ูุฑุชุจุท ุจ FIFO0
    CAN_FilterTypeDef.FilterActivation = ENABLE;            // ุชูููู ุงููุฑุดุญ
    HAL_CAN_ConfigFilter(&hcan1, &CAN_FilterTypeDef);
}
```

### ุงูุงุฎุชุจุงุฑ


```markdown
ุงูุชุญ ูุฏูุฑ ุงูุฃุฌูุฒุฉ ููุชุญูู ููุง ุฅุฐุง ูุงูุช ุงูุฌูุงุฒ ูุฏ ุธูุฑ ุจุงููุนู. ุฅุฐุง ูู ุชุฌุฏ ุงูุฌูุงุฒ ุฃู ุฅุฐุง ุธูุฑ ุฑูุฒ ุชุนุฌุจ ุฃุตูุฑุ ูุฑุฌู ุฒูุงุฑุฉ ูููุน ST ุงูุฑุณูู ูุชูุฒูู ุจุฑูุงูุฌ ุงูุชุดุบูู [STM32 Virtual COM Port Driver](https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-utilities/stsw-stm32102.html).

ุฅุฐุง ููุช ูุฏ ููุช ุจุชุซุจูุช ุจุฑูุงูุฌ ุงูุชุดุบูู ููุง ุชุฒุงู ุชูุงุฌู ูุดููุฉ ูู ุงูุชุนุฑู ุนูู ุงูุฌูุงุฒุ ููููู ูุญุงููุฉ ุถุจุท ุญุฌู ุงูุฐุงูุฑุฉ ุงูุฏููุง (Minimum Heap Size) ุนูู ูููุฉ 0x600 ุฃู ูููุฉ ุฃุนูู ูู CubeMX - Project Manager - Project - Linker Settings.

ุงูุชุญ ุฃุฏุงุฉ ุงูุงุชุตุงู ุงููุชุณูุณู (Serial) ุจุฃู ูุนุฏู ุจุช (Baud Rate) ููู ุจุฅุฑุณุงู ุฃู ุญุฑู. ุณุชุชููู ููุณ ุงูุญุฑู ูุฑุฏ ูู ุงูุฌูุงุฒ.

## ูุฑุงุฌุน ูุดูุฑ

- [STM32CubeMX ูููุชุจุฉ HAL - ุชุนูู ุงูุงุฎุชุจุงุฑ ุงูุฏูุฑู ุงูุจุณูุท ูุจุฑูุชูููู CAN](https://blog.csdn.net/weixin_45209978/article/details/119850600)

> ุนููุงู ุงููุต: <https://wiki-power.com/>
> ูุชู ุญูุงูุฉ ูุฐุง ุงูููุงู ุจููุฌุจ ุงุชูุงููุฉ [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)ุ ููุฑุฌู ุฐูุฑ ุงููุตุฏุฑ ุนูุฏ ุฅุนุงุฏุฉ ุงููุดุฑ.
```

Note: I have translated the content into Arabic while maintaining the original markdown format.

> ุชูุช ุชุฑุฌูุฉ ูุฐู ุงููุดุงุฑูุฉ ุจุงุณุชุฎุฏุงู ChatGPTุ ูุฑุฌู [**ุชุฒููุฏูุง ุจุชุนูููุงุชูู**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) ุฅุฐุง ูุงูุช ููุงู ุฃู ุญุฐู ุฃู ุฅููุงู.